<?xml version="1.0" encoding="UTF-8"?>
<definitions
  xmlns="http://www.omg.org/spec/BPMN/20100524/MODEL"
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xmlns:flowable="http://flowable.org/bpmn"
  xmlns:bpmndi="http://www.omg.org/spec/BPMN/20100524/DI"
  xmlns:omgdc="http://www.omg.org/spec/DD/20100524/DC"
  xmlns:omgdi="http://www.omg.org/spec/DD/20100524/DI"
  typeLanguage="http://www.w3.org/2001/XMLSchema"
  expressionLanguage="http://www.w3.org/1999/XPath"
  targetNamespace="http://provider.management/bpmn">

  <process
    id="serviceRequestBidding"
    name="Service Request Bidding"
    isExecutable="true">

    <!-- ===================== -->
    <!-- Start Event -->
    <!-- ===================== -->
    <startEvent id="startEvent" name="Start Bidding">
      <outgoing>flow_start_to_submit</outgoing>
    </startEvent>

    <!-- ===================== -->
    <!-- Supplier submits offer -->
    <!-- ===================== -->
    <userTask
      id="submitOfferTask"
      name="Submit Offer"
      flowable:candidateGroups="supplier_rep">
      <incoming>flow_start_to_submit</incoming>
      <outgoing>flow_submit_to_create_offer</outgoing>
    </userTask>

    <!-- ===================== -->
    <!-- Create Offer in Django -->
    <!-- ===================== -->
    <serviceTask
      id="createOfferTask"
      name="Create Offer (Django)"
      flowable:type="http">
      <incoming>flow_submit_to_create_offer</incoming>
      <outgoing>flow_create_to_submit_offer</outgoing>

      <extensionElements>
        <flowable:field name="requestMethod">
          <flowable:string>POST</flowable:string>
        </flowable:field>
        <flowable:field name="requestUrl">
          <flowable:string>${baseApiUrl}/api/requests/service-offers/</flowable:string>
        </flowable:field>
        <flowable:field name="requestHeaders">
          <flowable:string>
            <![CDATA[
              {
                "X-FLOWABLE-API-KEY": "super-secret-flowable-key",
                "Content-Type": "application/json"
              }
            ]]>
          </flowable:string>
        </flowable:field>
        <flowable:field name="requestBody">
          <flowable:string>
            <![CDATA[
              {
                "request": "${serviceRequestId}",
                "daily_rate": ${dailyRate},
                "travel_cost": ${travelCost},
                "total_cost": ${totalCost},
                "notes": "${notes}"
              }
            ]]>
          </flowable:string>
        </flowable:field>
        <flowable:field name="saveResponseParameters">
          <flowable:string>true</flowable:string>
        </flowable:field>
        <flowable:field name="responseVariableName">
          <flowable:string>createdOffer</flowable:string>
        </flowable:field>
      </extensionElements>
    </serviceTask>

    <!-- ===================== -->
    <!-- Submit Offer -->
    <!-- ===================== -->
    <serviceTask
      id="submitOfferApiTask"
      name="Submit Offer (Django)"
      flowable:type="http">
      <incoming>flow_create_to_submit_offer</incoming>
      <outgoing>flow_submit_offer_to_close</outgoing>

      <extensionElements>
        <flowable:field name="requestMethod">
          <flowable:string>POST</flowable:string>
        </flowable:field>
        <flowable:field name="requestUrl">
          <flowable:string>
            ${baseApiUrl}/api/requests/service-offers/${createdOffer.id}/submit/
          </flowable:string>
        </flowable:field>
        <flowable:field name="requestHeaders">
          <flowable:string>
            <![CDATA[
              {
                "Authorization": "Bearer ${authToken}"
              }
            ]]>
          </flowable:string>
        </flowable:field>
      </extensionElements>
    </serviceTask>

    <!-- ===================== -->
    <!-- Internal PM selects winner -->
    <!-- ===================== -->
    <userTask
      id="selectWinnerTask"
      name="Select Winning Offer"
      flowable:candidateGroups="internal_pm">
      <incoming>flow_submit_offer_to_close</incoming>
      <outgoing>flow_select_to_accept</outgoing>
    </userTask>

    <!-- ===================== -->
    <!-- Accept Offer -->
    <!-- ===================== -->
    <serviceTask
      id="acceptOfferTask"
      name="Accept Offer (Django)"
      flowable:type="http">
      <incoming>flow_select_to_accept</incoming>
      <outgoing>flow_accept_to_end</outgoing>

      <extensionElements>
        <flowable:field name="requestMethod">
          <flowable:string>POST</flowable:string>
        </flowable:field>
        <flowable:field name="requestUrl">
          <flowable:string>
            ${baseApiUrl}/api/requests/service-offers/${selectedOfferId}/accept/
          </flowable:string>
        </flowable:field>
        <flowable:field name="requestHeaders">
          <flowable:string>
            <![CDATA[
              {
                "Authorization": "Bearer ${authToken}"
              }
            ]]>
          </flowable:string>
        </flowable:field>
      </extensionElements>
    </serviceTask>

    <!-- ===================== -->
    <!-- End Event -->
    <!-- ===================== -->
    <endEvent id="endEvent" name="Order Created">
      <incoming>flow_accept_to_end</incoming>
    </endEvent>

    <!-- ===================== -->
    <!-- Sequence Flows -->
    <!-- ===================== -->
    <sequenceFlow id="flow_start_to_submit" sourceRef="startEvent" targetRef="submitOfferTask"/>
    <sequenceFlow id="flow_submit_to_create_offer" sourceRef="submitOfferTask" targetRef="createOfferTask"/>
    <sequenceFlow id="flow_create_to_submit_offer" sourceRef="createOfferTask" targetRef="submitOfferApiTask"/>
    <sequenceFlow id="flow_submit_offer_to_close" sourceRef="submitOfferApiTask" targetRef="selectWinnerTask"/>
    <sequenceFlow id="flow_select_to_accept" sourceRef="selectWinnerTask" targetRef="acceptOfferTask"/>
    <sequenceFlow id="flow_accept_to_end" sourceRef="acceptOfferTask" targetRef="endEvent"/>

  </process>
</definitions>
